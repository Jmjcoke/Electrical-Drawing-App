# Story 1.2: User Authentication and Profile Management

## Status: In-Progress

## Story

- As an Electrical Lead
- I want to authenticate using my company credentials 
- so that I can securely access the ELECTRICAL ORCHESTRATOR with appropriate role-based permissions

## Acceptance Criteria (ACs)

1. **Enterprise SSO Integration:** System integrates with enterprise SSO systems (SAML/LDAP) for seamless authentication
2. **Role-Based Access Control:** System implements 7 defined user roles with appropriate permissions and access restrictions
3. **Session Management:** System provides secure JWT token handling with automatic refresh and session timeout
4. **Account Recovery:** System includes password reset and account recovery workflows for non-SSO scenarios

## Tasks / Subtasks

- [ ] **Task 1: Set up Authentication Service Infrastructure** (AC: 1, 3)
  - [ ] Create Authentication Service in `src/backend/services/auth/` directory
  - [ ] Implement JWT token generation and validation using Python jose library
  - [ ] Configure Redis session storage for token management and caching
  - [ ] Set up CORS and security headers in FastAPI gateway middleware

- [ ] **Task 2: Implement Enterprise SSO Integration** (AC: 1)
  - [ ] Install and configure python-saml library for SAML authentication
  - [ ] Implement LDAP integration using python-ldap for directory services
  - [ ] Create SSO callback endpoints in FastAPI gateway (`/auth/saml/callback`, `/auth/ldap/callback`)
  - [ ] Add environment configuration for SSO provider settings (SAML metadata, LDAP server details)

- [ ] **Task 3: Create User Role and Permission System** (AC: 2)
  - [ ] Define User and Role models in PostgreSQL with foreign key relationships
  - [ ] Implement 7 user roles: System Admin, Electrical Lead, FCO Lead, Project Manager, Foreman, General Foreman, Superintendent, Electrician, FCO Technician
  - [ ] Create permission enum and role-permission mapping tables
  - [ ] Implement role-based middleware decorator for API endpoint protection

- [ ] **Task 4: Build Frontend Authentication Components** (AC: 1, 2, 3)
  - [ ] Create AuthStore in Zustand with user, role, permissions, login, logout, refreshToken methods
  - [ ] Implement login page UI component with SSO provider selection
  - [ ] Build authentication middleware for Next.js App Router route protection
  - [ ] Create user profile component displaying role and permissions

- [ ] **Task 5: Implement Session Management and Security** (AC: 3, 4)
  - [ ] Configure JWT token expiration and refresh token rotation
  - [ ] Implement automatic token refresh using Axios interceptors
  - [ ] Add session timeout handling with user notification
  - [ ] Create password reset workflow for non-SSO users with email verification

- [ ] **Task 6: Testing and Security Validation** (AC: 1, 2, 3, 4)
  - [ ] Write unit tests for authentication service endpoints
  - [ ] Create integration tests for SSO flows with mock providers
  - [ ] Implement security tests for token validation and role-based access
  - [ ] Add end-to-end tests for login/logout workflows using Playwright

## Dev Technical Guidance

### **Authentication Architecture Integration**
- **Backend Service Location:** `src/backend/services/auth/main.py` following microservices architecture pattern
- **Database Schema:** Reference `electrical-orchestrator-architecture.md` Section 6.1 for User and Role table definitions
- **JWT Configuration:** Use RS256 algorithm with 15-minute access tokens and 7-day refresh tokens stored in Redis
- **SSO Provider Integration:** Support both SAML 2.0 and LDAP protocols for enterprise directory integration

### **Frontend State Management**
- **AuthStore Implementation:** Follow Zustand patterns from `frontend-architecture.md` Section V for state management
- **API Client Setup:** Use Axios interceptors pattern from `frontend-architecture.md` Section VI for automatic token attachment
- **Route Protection:** Implement Next.js middleware following `frontend-architecture.md` Section VII routing strategy
- **Component Structure:** Place authentication components in `src/frontend/components/auth/` directory

### **Security Requirements**
- **Token Storage:** Store JWT tokens in httpOnly cookies with secure and sameSite flags
- **CSRF Protection:** Implement CSRF tokens for state-changing operations
- **Rate Limiting:** Apply rate limiting to authentication endpoints (5 attempts per minute per IP)
- **Audit Logging:** Log all authentication events to PostgreSQL audit table with user, timestamp, IP, and outcome

### **User Role Definitions** 
Reference PRD Section 2.2 for complete role definitions:
- **Management Roles:** Electrical Lead, FCO Lead, Project Manager, Foreman, General Foreman, Superintendent
- **Execution Roles:** Electrician, FCO Technician
- **Administrative Role:** System Administrator

### **Environment Configuration**
```bash
# Required environment variables for authentication
JWT_SECRET_KEY=<RSA private key>
JWT_PUBLIC_KEY=<RSA public key>
SAML_METADATA_URL=<Enterprise SSO metadata URL>
LDAP_SERVER_URL=<LDAP server connection string>
REDIS_URL=<Redis connection for session storage>
```

### **API Endpoints to Implement**
- `POST /auth/login` - Username/password authentication
- `POST /auth/saml/login` - SAML SSO initiation
- `POST /auth/ldap/login` - LDAP authentication
- `POST /auth/refresh` - Token refresh endpoint
- `POST /auth/logout` - Session termination
- `GET /auth/profile` - Current user profile and permissions
- `POST /auth/reset-password` - Password reset initiation

## Story Progress Notes

### Agent Model Used: `Claude Sonnet 4 (2025-05-14)`

### Completion Notes List
{Implementation notes will be added during development}

### Change Log
- **2025-01-25:** Initial story creation by Technical Scrum Master following BMAD methodology