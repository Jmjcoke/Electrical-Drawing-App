# Story 3.5: AI Estimation Dashboard

## Status: Approved

## Story
- As an **electrical contractor**
- I want **an AI-powered estimation dashboard that calculates man-hours and costs based on circuit complexity and historical data**
- so that **I can generate accurate project bids, plan resource allocation, and track estimation accuracy over time**

## Acceptance Criteria (ACs)
1. **Circuit Complexity Analysis**: Automatically analyze detected components and circuit topology to generate complexity scores with breakdown by installation difficulty
2. **Man-Hour Estimation**: Calculate role-based hour estimates (electricians, apprentices, supervisors) using AI models trained on historical project data
3. **Cost Estimation Dashboard**: Display comprehensive cost breakdowns including labor, materials, equipment, and contingency with confidence intervals
4. **Historical Pattern Matching**: Show similar past projects with actual vs estimated comparisons and accuracy metrics
5. **Estimation Refinement Tools**: Allow manual adjustments with AI learning from corrections to improve future estimates

## Tasks / Subtasks
- [ ] **Circuit Complexity Analysis**
  - [ ] Integrate Man-Hour Estimation Service for complexity scoring
  - [ ] Create CircuitComplexityAnalyzer component with visual complexity indicators
  - [ ] Implement component difficulty classification (standard, complex, specialized)
  - [ ] Build circuit topology complexity calculation based on connection density

- [ ] **Man-Hour Estimation Engine**
  - [ ] Create EstimationDashboard with role-based hour breakdowns
  - [ ] Implement historical pattern matching for similar project types
  - [ ] Build confidence interval display for estimation reliability
  - [ ] Add estimation comparison with industry benchmarks

- [ ] **Cost Breakdown Visualization**
  - [ ] Create CostBreakdownChart with interactive cost categories
  - [ ] Implement material cost integration with component pricing data
  - [ ] Build labor rate configuration with regional adjustments
  - [ ] Add overhead and profit margin configuration

- [ ] **Historical Analysis Interface**
  - [ ] Create HistoricalProjectsPanel with similar project identification
  - [ ] Implement estimation accuracy tracking with actual vs predicted analysis
  - [ ] Build project completion data visualization with trend analysis
  - [ ] Add estimation performance metrics dashboard

- [ ] **Estimation Refinement System**
  - [ ] Create EstimationRefinementTools for manual adjustments
  - [ ] Implement feedback collection for actual completion times
  - [ ] Build AI model retraining pipeline with user corrections
  - [ ] Add estimation template creation for common project types

## Dev Technical Guidance
### **Technical Implementation Details**

**Estimation Dashboard Architecture:**
```typescript
// Estimation state management
interface EstimationDashboardState {
  currentEstimation: ProjectEstimation | null;
  complexityAnalysis: CircuitComplexityAnalysis;
  historicalComparisons: HistoricalProject[];
  manHourBreakdown: ManHourBreakdown;
  costBreakdown: CostBreakdown;
  confidenceMetrics: EstimationConfidence;
}

interface ProjectEstimation {
  id: string;
  projectId: string;
  circuitComplexity: number;
  estimatedHours: ManHourBreakdown;
  estimatedCosts: CostBreakdown;
  confidenceLevel: number;
  lastUpdated: Date;
}

interface ManHourBreakdown {
  electrician: { hours: number; rate: number };
  apprentice: { hours: number; rate: number };
  supervisor: { hours: number; rate: number };
  total: number;
}
```

**Complexity Analysis Implementation:**
```typescript
// Circuit complexity scoring
const CircuitComplexityAnalyzer: React.FC<{
  detectedComponents: ComponentDetection[];
  circuitPaths: CircuitPath[];
}> = ({ detectedComponents, circuitPaths }) => {
  const complexityScore = useMemo(() => {
    const componentComplexity = calculateComponentComplexity(detectedComponents);
    const topologyComplexity = calculateTopologyComplexity(circuitPaths);
    const installationComplexity = calculateInstallationComplexity(detectedComponents);
    
    return {
      overall: (componentComplexity + topologyComplexity + installationComplexity) / 3,
      breakdown: {
        components: componentComplexity,
        topology: topologyComplexity,
        installation: installationComplexity
      }
    };
  }, [detectedComponents, circuitPaths]);
  
  return (
    <div className="complexity-analysis">
      <ComplexityMeter score={complexityScore.overall} />
      <ComplexityBreakdown breakdown={complexityScore.breakdown} />
    </div>
  );
};
```

**Historical Pattern Matching:**
```typescript
// Historical project comparison
interface HistoricalProject {
  id: string;
  projectName: string;
  circuitType: string;
  componentCount: number;
  complexityScore: number;
  estimatedHours: number;
  actualHours: number;
  accuracy: number;
  completionDate: Date;
}

const useHistoricalPatterns = (currentProject: ProjectSpecs) => {
  const [similarProjects, setSimilarProjects] = useState<HistoricalProject[]>([]);
  
  useEffect(() => {
    const findSimilarProjects = async () => {
      const patterns = await estimationService.findSimilarProjects({
        circuitType: currentProject.circuitType,
        componentCount: currentProject.componentCount,
        complexityRange: [currentProject.complexity - 0.2, currentProject.complexity + 0.2]
      });
      setSimilarProjects(patterns);
    };
    
    findSimilarProjects();
  }, [currentProject]);
  
  return { similarProjects };
};
```

**Performance Requirements:**
- Complexity analysis: <1 second for 100+ components
- Estimation calculation: <2 seconds for complete project analysis
- Historical pattern matching: <500ms for similar project lookup
- Dashboard rendering: <300ms for cost breakdowns and charts

**Machine Learning Integration:**
```typescript
// AI model integration for estimation
interface EstimationMLModel {
  version: string;
  accuracy: number;
  trainingDate: Date;
  features: string[];
}

const estimationConfig = {
  models: {
    complexity: 'xgboost-complexity-v2.1',
    manHours: 'random-forest-hours-v1.8',
    costPredictor: 'neural-network-cost-v1.3'
  },
  confidenceThresholds: {
    high: 0.85,
    medium: 0.70,
    low: 0.50
  }
};
```

**API Integration:**
- Man-Hour Estimation Service: `/api/v1/estimation/predict-hours`
- Historical patterns: `/api/v1/estimation/historical-patterns`
- Complexity analysis: `/api/v1/estimation/analyze-circuit`
- Model feedback: `/api/v1/estimation/feedback`

**Data Visualization:**
```typescript
// D3.js charts for estimation dashboard
const EstimationCharts = {
  costBreakdown: 'donut-chart', // Labor vs materials vs overhead
  hoursTrend: 'line-chart', // Historical accuracy over time
  complexityDistribution: 'histogram', // Project complexity distribution
  accuracyMetrics: 'gauge-chart' // Current estimation confidence
};

// Chart performance optimization
const chartConfig = {
  animation: true,
  responsive: true,
  updateDelay: 150,
  maxDataPoints: 1000
};
```

**Security Considerations:**
- Estimation data encryption for sensitive pricing information
- Role-based access to cost data and profit margins
- Rate limiting for estimation requests (10 per minute per user)
- Audit logging for manual estimation adjustments

## Story Progress Notes
### Agent Model Used: `Claude Sonnet 4 (2025-05-14)`
### Completion Notes List
- Story created with comprehensive AI estimation dashboard system
- Machine learning integration for accurate hour and cost prediction
- Historical pattern matching for estimation validation
- Interactive refinement tools for continuous AI improvement

### Change Log
- **2025-05-28**: Initial story creation with estimation dashboard specifications

## Story Definition of Done (DoD) Checklist Report
### 1. Requirements Met: ⏳ (Pending Implementation)
- [ ] Circuit complexity analysis with breakdown visualization
- [ ] Man-hour estimation with role-based calculations
- [ ] Cost estimation dashboard with comprehensive breakdowns
- [ ] Historical pattern matching with accuracy metrics
- [ ] Estimation refinement tools with AI learning

### 2. Coding Standards & Project Structure: ⏳ (Pending Implementation)
- [ ] TypeScript with strict configuration
- [ ] React components following project patterns
- [ ] D3.js integration for data visualization
- [ ] Machine learning model integration

### 3. Testing: ⏳ (Pending Implementation)
- [ ] Unit tests for estimation calculations
- [ ] Integration tests for ML model API calls
- [ ] Performance tests for large project analysis
- [ ] Accuracy tests against historical data

### 4. Documentation: ⏳ (Pending Implementation)
- [ ] Estimation algorithm documentation
- [ ] Historical pattern matching guide
- [ ] Dashboard usage instructions
- [ ] Model training and feedback process

### Final Confirmation: ⏳ (Pending Implementation)
- [ ] All DoD items verified and story ready for review

## Dependencies
- **Builds Upon**: Story 3.3 (Circuit Tracing) - requires circuit complexity data
- **Enables**: Complete AI feature set - final story in Epic 3
- **Related**: Story 3.4 (Component Intelligence) - uses component specifications for cost calculation