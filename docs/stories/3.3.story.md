# Story 3.3: Circuit Tracing Visualization

## Status: Approved

## Story
- As an **electrical contractor**
- I want **interactive circuit path visualization that shows electrical connections from any selected component**
- so that **I can understand circuit topology, trace power flow, and verify electrical connections during installation planning**

## Acceptance Criteria (ACs)
1. **Interactive Circuit Tracing**: Click any detected component to initiate circuit tracing with visual path highlighting in real-time
2. **Bidirectional Path Visualization**: Circuit traces display both upstream (power source) and downstream (load) connections with directional indicators
3. **Multi-path Circuit Support**: Complex circuits with multiple branches are visualized with different colors and clear junction points
4. **Component Connection Details**: Hover over traced connections to see voltage, amperage, and wire specifications for each circuit segment
5. **Circuit Topology Graph**: Side panel displays interactive circuit diagram showing component relationships and electrical characteristics

## Tasks / Subtasks
- [ ] **Circuit Tracing Integration**
  - [ ] Implement Circuit Tracing Service client with path analysis API calls
  - [ ] Create useCircuitTracing hook for component-to-component path requests
  - [ ] Build CircuitTracingOverlay component for canvas path rendering
  - [ ] Add tracing direction controls (upstream, downstream, bidirectional)

- [ ] **Path Visualization System**
  - [ ] Implement SVG path rendering for electrical connections on canvas
  - [ ] Create path styling system with directional arrows and connection types
  - [ ] Build multi-path color coding (primary: blue, secondary: green, tertiary: orange)
  - [ ] Add animated path highlighting during tracing discovery

- [ ] **Circuit Topology Interface**
  - [ ] Create CircuitTopologyPanel with interactive graph visualization
  - [ ] Implement NetworkX graph rendering using D3.js for component relationships
  - [ ] Build component node styling based on electrical specifications
  - [ ] Add graph zoom, pan, and node selection synchronization with canvas

- [ ] **Connection Details System**
  - [ ] Implement connection hover tooltips with electrical specifications
  - [ ] Create ConnectionDetailsModal for detailed circuit segment information
  - [ ] Build wire specification lookup integration with Component Intelligence Service
  - [ ] Add connection validation indicators (verified, assumed, invalid)

- [ ] **Circuit Path Management**
  - [ ] Create path history tracking with undo/redo functionality
  - [ ] Implement path comparison mode for multiple trace results
  - [ ] Build path export functionality (PDF, image, circuit diagram)
  - [ ] Add path sharing and collaboration features

## Dev Technical Guidance
### **Technical Implementation Details**

**Circuit Tracing Architecture:**
```typescript
// Circuit tracing component integration
interface CircuitTracingProps {
  selectedComponent: ComponentDetection;
  traceDirection: 'upstream' | 'downstream' | 'bidirectional';
  onPathDiscovered: (path: CircuitPath) => void;
  maxTraceDepth: number;
}

// Circuit path data structure
interface CircuitPath {
  id: string;
  sourceComponent: ComponentDetection;
  targetComponent: ComponentDetection;
  segments: CircuitSegment[];
  totalDistance: number;
  powerFlow: 'upstream' | 'downstream';
  confidence: number;
}

interface CircuitSegment {
  from: ComponentDetection;
  to: ComponentDetection;
  wireSpecifications: WireSpecs;
  voltage: number;
  amperage: number;
  pathCoordinates: Point[];
}
```

**Canvas Path Rendering:**
```typescript
// SVG overlay for circuit paths
const CircuitPathRenderer: React.FC<{
  paths: CircuitPath[];
  selectedPath?: string;
}> = ({ paths, selectedPath }) => {
  return (
    <svg className="circuit-path-overlay">
      {paths.map((path) => (
        <g key={path.id} className={`circuit-path ${path.id === selectedPath ? 'selected' : ''}`}>
          {path.segments.map((segment, index) => (
            <path
              key={index}
              d={createPathString(segment.pathCoordinates)}
              stroke={getPathColor(path.powerFlow)}
              strokeWidth="3"
              fill="none"
              markerEnd="url(#arrowhead)"
            />
          ))}
        </g>
      ))}
    </svg>
  );
};
```

**Performance Requirements:**
- Circuit tracing response: <2 seconds for standard circuits
- Path rendering: <200ms for up to 50 components
- Graph visualization: <500ms for complex topologies
- Real-time updates: <100ms for path selection changes

**Circuit Topology Visualization:**
```typescript
// D3.js integration for circuit graph
interface CircuitGraphNode {
  id: string;
  component: ComponentDetection;
  x: number;
  y: number;
  connections: string[];
}

interface CircuitGraphEdge {
  source: string;
  target: string;
  weight: number;
  specifications: WireSpecs;
}

// Graph layout algorithm preferences
const circuitGraphConfig = {
  layout: 'force-directed', // Alternative: 'hierarchical'
  nodeSpacing: 100,
  edgeLength: 150,
  clustering: true // Group related components
};
```

**API Integration:**
- Circuit Tracing Service: `/api/v1/circuit/trace-path`
- Component Intelligence: `/api/v1/components/{id}/connections`
- Real-time updates via WebSocket: `/ws/circuit-trace/${traceId}`

**Security Considerations:**
- Validate component IDs before tracing requests
- Rate limit tracing requests (max 5 concurrent per user)
- Cache tracing results for 15 minutes to reduce API load
- Sanitize circuit data before rendering

## Story Progress Notes
### Agent Model Used: `Claude Sonnet 4 (2025-05-14)`
### Completion Notes List
- Story created with comprehensive circuit tracing visualization system
- Integration with Circuit Tracing Service and Component Intelligence APIs
- D3.js graph visualization for complex circuit topology display
- Multi-path support for complex electrical systems

### Change Log
- **2025-05-28**: Initial story creation with circuit visualization specifications

## Story Definition of Done (DoD) Checklist Report
### 1. Requirements Met: ⏳ (Pending Implementation)
- [ ] Interactive circuit tracing from selected components
- [ ] Bidirectional path visualization with directional indicators
- [ ] Multi-path circuit support with color coding
- [ ] Component connection details on hover
- [ ] Circuit topology graph in side panel

### 2. Coding Standards & Project Structure: ⏳ (Pending Implementation)
- [ ] TypeScript with strict configuration
- [ ] React components following project patterns
- [ ] D3.js integration for graph visualization
- [ ] SVG rendering optimization for canvas overlays

### 3. Testing: ⏳ (Pending Implementation)
- [ ] Unit tests for circuit tracing logic
- [ ] Integration tests for path visualization
- [ ] Performance tests for complex circuit rendering
- [ ] E2E tests for user interaction workflows

### 4. Documentation: ⏳ (Pending Implementation)
- [ ] Circuit tracing API documentation
- [ ] Path visualization usage guide
- [ ] Circuit topology interpretation guide
- [ ] Performance optimization notes

### Final Confirmation: ⏳ (Pending Implementation)
- [ ] All DoD items verified and story ready for review

## Dependencies
- **Builds Upon**: Story 3.1 (Interactive Drawing Canvas) - requires component selection capability
- **Enables**: Story 3.5 (AI Estimation Dashboard) - provides circuit complexity data for estimation
- **Related**: Story 3.4 (Component Intelligence Search) - shares component specification lookup